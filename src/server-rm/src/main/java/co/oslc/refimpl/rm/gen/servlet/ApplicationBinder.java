// Start of user code Copyright
/*
 * Copyright (c) 2020 Contributors to the Eclipse Foundation
 *
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Distribution License 1.0 which is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Simple
 *
 * This file is generated by Lyo Designer (https://www.eclipse.org/lyo/)
 */
// End of user code

package co.oslc.refimpl.rm.gen.servlet;

// spotless:off
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.glassfish.hk2.api.Factory;
import org.glassfish.hk2.utilities.binding.AbstractBinder;

import jakarta.inject.Inject;
import jakarta.inject.Singleton;
import jakarta.ws.rs.core.UriBuilder;
import jakarta.servlet.ServletContext;

import co.oslc.refimpl.rm.gen.RestDelegate;
import co.oslc.refimpl.rm.gen.ServiceProviderInfo;
import co.oslc.refimpl.rm.gen.ResourcesFactory;
import static co.oslc.refimpl.rm.gen.servlet.ServletListener.getConfigurationProperty;
import static co.oslc.refimpl.rm.gen.servlet.ServletListener.getServletUrlPattern;
import java.util.Set;

import java.net.URI;
import java.util.ArrayList;
import java.util.Map;

import org.eclipse.lyo.oslc4j.trs.server.InmemPagedTrs;
import org.eclipse.lyo.oslc4j.trs.server.PagedTrs;
import org.eclipse.lyo.oslc4j.trs.server.PagedTrsFactory;
import org.eclipse.lyo.oslc4j.trs.server.TrsEventHandler;
import org.eclipse.lyo.oslc.domains.rm.Requirement;
import org.eclipse.lyo.oslc.domains.rm.RequirementCollection;
import org.eclipse.lyo.oslc4j.core.OSLC4JUtils;
// Start of user code imports
// End of user code
// spotless:on

// Start of user code pre_class_code
// End of user code

public class ApplicationBinder extends AbstractBinder {

    private static final Logger log = LoggerFactory.getLogger(ApplicationBinder.class);

    // Start of user code class_attributes
    
    // End of user code

    // Start of user code class_methods
    // End of user code

    public ApplicationBinder()
    {
        log.info("HK2 contract binding init");
    }

    @Override
    protected void configure() {
        log.info("HK2 contract binding start");
    
        // Start of user code ConfigureInitialise
        // End of user code
        bindFactory(LyoAppConfigurationFactory.class)
                .to(LyoAppConfiguration.class);
        bindAsContract(RestDelegate.class).in(Singleton.class);
        bindFactory(ResourcesFactoryFactory.class).to(ResourcesFactory.class).in(Singleton.class);
    
    
        bindFactory(InmemTrsEventHandlerFactory.class).to(TrsEventHandler.class).in(Singleton.class);
        bindFactory(InmemPagedTrsFactory.class).to(PagedTrs.class).in(Singleton.class);
    
        // Start of user code ConfigureFinalize
        // End of user code
    }
    static class ResourcesFactoryFactory implements Factory<ResourcesFactory> {
        @Override
        public ResourcesFactory provide() {
            return new ResourcesFactory(OSLC4JUtils.getServletURI());
        }
    
        @Override
        public void dispose(ResourcesFactory instance) {
        }
    }
    public static class LyoAppConfigurationFactory implements Factory<LyoAppConfiguration> {
        private static final Logger logger = LoggerFactory.getLogger(LyoAppConfigurationFactory.class);
    
        private final LyoAppConfiguration instance;
    
        @Inject
        public LyoAppConfigurationFactory(ServletContext context) {
            String corsFriendsString = getConfigurationProperty("cors.friends", "", context, ServletListener.class);
            Set<String> corsFriends;
            if (corsFriendsString == null || corsFriendsString.isEmpty()) {
                corsFriends = Set.of();
            } else {
                corsFriends = java.util.Arrays.stream(corsFriendsString.split(";"))
                    .map(String::trim)
                    .filter(s -> !s.isEmpty())
                    .collect(java.util.stream.Collectors.toSet());
            }
            this.instance = new LyoAppConfiguration(OSLC4JUtils.getPublicURI(), OSLC4JUtils.getServletPath(), corsFriends);
        }
    
        @Override
        public LyoAppConfiguration provide() {
            return instance;
        }
    
        @Override
        public void dispose(LyoAppConfiguration instance) {
            // Noop
        }
    }
    
    static class InmemTrsEventHandlerFactory implements Factory<TrsEventHandler> {
        // Start of user code TrsEventHandlerInitialise
        // End of user code
    
        @Override
        public TrsEventHandler provide() {
            ArrayList<URI> uris = new ArrayList<URI>();
            // Start of user code TrsEventHandlerInitialBase
            //TODO: Provide the initial list of URIs to populate the TRS log with
            Map<String, Requirement> requirements = RestDelegate.requirementsForSP(RestDelegate.SP_DEFAULT);
            for (Requirement requirement : requirements.values()) {
                uris.add(requirement.getAbout());
            }
            Map<String, RequirementCollection> requirementCollections = RestDelegate.requirementCollectionsForSP(RestDelegate.SP_DEFAULT);
            for (RequirementCollection requirementCollection : requirementCollections.values()) {
                uris.add(requirementCollection.getAbout());
            }
            // End of user code
    
            InmemPagedTrs inmemTrs = new PagedTrsFactory().getInmemPagedTrs(5, 5, uris);
            return inmemTrs;
        }
    
        @Override
        public void dispose(TrsEventHandler instance) {
            // Start of user code TrsEventHandlerDispose
            // End of user code
        }
    }
    
    static class InmemPagedTrsFactory implements Factory<PagedTrs> {
        @Inject TrsEventHandler trsEventHandler;
    
        @Override
        public PagedTrs provide() {
            // Start of user code PagedTrsInitialise
            // End of user code
            return (InmemPagedTrs) trsEventHandler;
        }
    
        @Override
        public void dispose(PagedTrs instance) {
            // Start of user code PagedTrsDispose
            // End of user code
        }
    }
}
